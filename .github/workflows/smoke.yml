name: Smoke Training

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:
  smoke-run:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          activate-environment: "true"
          enable-cache: "true"
          restore-cache: "true"
          save-cache: "true"
          cache-python: "true"

      - name: Sync dependencies
        run: uv sync

      - name: Prepare smoke dataset
        run: |
          uv run python - <<'PY'
          from pathlib import Path

          import numpy as np
          from PIL import Image

          import shutil

          classes = (
              "angry",
              "disgusted",
              "fearful",
              "happy",
              "neutral",
              "sad",
              "surprised",
          )
          root = Path("data")
          if root.exists():
              shutil.rmtree(root)
          root.mkdir(exist_ok=True)
          for split, count in (("train", 4), ("test", 2)):
              for idx, name in enumerate(classes):
                  class_dir = root / split / name
                  class_dir.mkdir(parents=True, exist_ok=True)
                  for img_idx in range(count):
                      value = int(((idx + 1) * (img_idx + 1) * 37) % 255)
                      arr = np.full((48, 48), value, dtype=np.uint8)
                      Image.fromarray(arr).save(class_dir / f"img{img_idx}.png")
          PY

      - name: Run smoke training config
        run: |
          uv run python -m src.main \
            --config configs/smoke.json \
            --output-dir runs \
            --seed 0 \
            --experiment-name gh-smoke

      - name: Validate smoke metrics
        run: |
          uv run python - <<'PY'
          import json
          import math
          from pathlib import Path

          runs_dir = Path("runs")
          if not runs_dir.exists():
              raise SystemExit("runs directory missing after smoke execution")
          run_dirs = sorted(runs_dir.glob("*"), key=lambda p: p.stat().st_mtime)
          if not run_dirs:
              raise SystemExit("no run directories found")
          latest = run_dirs[-1]
          metrics_path = latest / "metrics.json"
          if not metrics_path.exists():
              raise SystemExit(f"metrics.json missing at {metrics_path}")
          metrics = json.loads(metrics_path.read_text())
          required = [
              "train_loss",
              "train_accuracy",
              "val_loss",
              "val_accuracy",
          ]
          for key in required:
              if key not in metrics:
                  raise SystemExit(f"missing metric: {key}")
              value = metrics[key]
              if value is None or (isinstance(value, float) and math.isnan(value)):
                  raise SystemExit(f"invalid value for metric {key}: {value}")
          PY

      - name: Upload smoke artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-run-artifacts
          path: |
            runs
            data
